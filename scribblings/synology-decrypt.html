<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"/><meta name="viewport" content="width=device-width, initial-scale=0.8"/><title>synology-decrypt</title><link rel="stylesheet" type="text/css" href="scribble.css" title="default"/><link rel="stylesheet" type="text/css" href="racket.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-style.css" title="default"/><link rel="stylesheet" type="text/css" href="manual-racket.css" title="default"/><script type="text/javascript" src="scribble-common.js"></script><script type="text/javascript" src="manual-racket.js"></script><!--[if IE 6]><style type="text/css">.SIEHidden { overflow: hidden; }</style><![endif]--></head><body id="scribble-racket-lang-org"><div class="tocset"><div class="tocview"><div class="tocviewlist tocviewlisttopspace"><div class="tocviewtitle"><table cellspacing="0" cellpadding="0"><tr><td style="width: 1em;"><a href="javascript:void(0);" title="Expand/Collapse" class="tocviewtoggle" onclick="TocviewToggle(this,&quot;tocview_0&quot;);">&#9658;</a></td><td></td><td><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html" class="tocviewselflink" data-pltdoc="x">synology-<wbr></wbr>decrypt</a></td></tr></table></div><div class="tocviewsublistonly" style="display: none;" id="tocview_0"><table cellspacing="0" cellpadding="0"><tr><td align="right">1&nbsp;</td><td><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28part._.Running_the_program%29" class="tocviewlink" data-pltdoc="x">Running the program</a></td></tr><tr><td align="right">2&nbsp;</td><td><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28part._.Reference%29" class="tocviewlink" data-pltdoc="x">Reference</a></td></tr><tr><td align="right">3&nbsp;</td><td><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28part._file-format%29" class="tocviewlink" data-pltdoc="x">Encrypted File Format</a></td></tr><tr><td align="right">4&nbsp;</td><td><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28part._.References_and_.Acknowledgements%29" class="tocviewlink" data-pltdoc="x">References and Acknowledgements</a></td></tr></table></div></div></div><div class="tocsub"><table class="tocsublist" cellspacing="0"><tr><td><span class="tocsublinknumber"></span><a href="#%28part._synology-decrypt%29" class="tocsubseclink" data-pltdoc="x">synology-<wbr></wbr>decrypt</a></td></tr><tr><td><span class="tocsublinknumber">1<tt>&nbsp;</tt></span><a href="#%28part._.Running_the_program%29" class="tocsubseclink" data-pltdoc="x">Running the program</a></td></tr><tr><td><span class="tocsublinknumber">2<tt>&nbsp;</tt></span><a href="#%28part._.Reference%29" class="tocsubseclink" data-pltdoc="x">Reference</a></td></tr><tr><td><a href="#%28def._%28%28lib._synology-decrypt%2Fmain..rkt%29._decrypt-ports%29%29" class="tocsubnonseclink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">decrypt-<wbr></wbr>ports</span></span></a></td></tr><tr><td><a href="#%28def._%28%28lib._synology-decrypt%2Fmain..rkt%29._decrypt-file%29%29" class="tocsubnonseclink" data-pltdoc="x"><span class="RktSym"><span class="RktValLink">decrypt-<wbr></wbr>file</span></span></a></td></tr><tr><td><span class="tocsublinknumber">3<tt>&nbsp;</tt></span><a href="#%28part._file-format%29" class="tocsubseclink" data-pltdoc="x">Encrypted File Format</a></td></tr><tr><td><span class="tocsublinknumber">3.1<tt>&nbsp;</tt></span><a href="#%28part._.Syntax%29" class="tocsubseclink" data-pltdoc="x">Syntax</a></td></tr><tr><td><span class="tocsublinknumber">3.2<tt>&nbsp;</tt></span><a href="#%28part._.Semantics%29" class="tocsubseclink" data-pltdoc="x">Semantics</a></td></tr><tr><td><span class="tocsublinknumber">3.3<tt>&nbsp;</tt></span><a href="#%28part._kdf%29" class="tocsubseclink" data-pltdoc="x">Key Derivation Function</a></td></tr><tr><td><span class="tocsublinknumber">4<tt>&nbsp;</tt></span><a href="#%28part._.References_and_.Acknowledgements%29" class="tocsubseclink" data-pltdoc="x">References and Acknowledgements</a></td></tr></table></div></div><div class="maincolumn"><div class="main"><div class="versionbox"><span class="versionNoNav">8.9</span></div><h2><a name="(part._synology-decrypt)"></a><a name="(mod-path._synology-decrypt)"></a>synology-decrypt</h2><div class="SAuthorListBox"><span class="SAuthorList"><p class="author">Nikhil Marathe &lt;<a href="mailto:me@nikhilism.com">me@nikhilism.com</a>&gt;</p></span></div><p><table cellspacing="0" cellpadding="0" class="defmodule"><tr><td align="left"><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._require%29%29" class="RktStxLink" data-pltdoc="x">require</a></span><span class="stt"> </span><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html" class="RktModLink" data-pltdoc="x"><span class="RktSym">synology-decrypt</span></a><span class="RktPn">)</span></td><td align="right"><span class="RpackageSpec"><span class="Smaller">&nbsp;package:</span> <a href="https://pkgs.racket-lang.org/package/synology-decrypt" title="Install this package using `raco pkg install synology-decrypt`"><span class="stt">synology-decrypt</span></a></span></td></tr></table></p><p>This package implements a library and command-line client to decrypt files encrypted by the <a href="https://www.synology.com/en-us/dsm/feature/cloud_sync">Synology Cloudsync</a> program.</p><p><div class="SIntrapara">Files may be encrypted with either a password or a private key. This module has the following limitations:
</div><div class="SIntrapara"><ul><li><p>It only supports password based decryption.</p></li><li><p>It only supports version 3.1 of the <a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28part._file-format%29" data-pltdoc="x">encryption format</a>.</p></li></ul></div></p><h3>1<tt>&nbsp;</tt><a name="(part._.Running_the_program)"></a>Running the program</h3><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktSym">racket</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">main.rkt</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;encrypted</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/require.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._file%29%29" class="RktStxLink" data-pltdoc="x">file</a></span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">path&gt;</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">&lt;decrypted</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">output</span><span class="RktMeta"></span><span class="hspace">&nbsp;</span><span class="RktMeta"></span><span class="RktSym">path&gt;</span><span class="RktMeta"></span></td></tr></table></blockquote><p>When run like this, the program will read standard input to obtain the decryption password. Standard input is read to avoid leaking the password in shell history or in-memory process information. Type the password and press Ctrl+D to close standard input.</p><p>Run with <span class="RktInBG"><span class="hspace"></span><span class="RktIn">--help</span><span class="hspace"></span></span> to see all the options.</p><h3>2<tt>&nbsp;</tt><a name="(part._.Reference)"></a>Reference</h3><p>This package can also be used as a library.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>procedure</p></div></div><table cellspacing="0" cellpadding="0" class="prototype RForeground"><tr><td valign="top"><span class="RktPn">(</span><a name="(def._((lib._synology-decrypt/main..rkt)._decrypt-ports))"></a><span title="Provided from: synology-decrypt | Package: synology-decrypt"><span class="RktSym"><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28def._%28%28lib._synology-decrypt%2Fmain..rkt%29._decrypt-ports%29%29" class="RktValDef RktValLink" data-pltdoc="x">decrypt-ports</a></span></span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktVar">password</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktVar">input-port</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktVar">output</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span><span class="RktOpt">[</span></td><td valign="top"><span class="RktPn">#:external-lz4</span><span class="hspace">&nbsp;</span><span class="RktVar">use-external-lz4?</span><span class="RktOpt">]</span><span class="RktPn">)</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top">&rarr;</td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/void.html#%28def._%28%28quote._~23~25kernel%29._void~3f%29%29" class="RktValLink" data-pltdoc="x">void?</a></span></td></tr></table></blockquote></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">password</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string~3f%29%29" class="RktValLink" data-pltdoc="x">string?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">input-port</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/port-ops.html#%28def._%28%28quote._~23~25kernel%29._input-port~3f%29%29" class="RktValLink" data-pltdoc="x">input-port?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">output</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/Manipulating_Paths.html#%28def._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._path-string~3f%29%29" class="RktValLink" data-pltdoc="x">path-string?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">use-external-lz4?</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/booleans.html#%28def._%28%28quote._~23~25kernel%29._boolean~3f%29%29" class="RktValLink" data-pltdoc="x">boolean?</a></span><span class="hspace">&nbsp;</span>=<span class="hspace">&nbsp;</span><span class="RktVal">#f</span></td></tr></table></blockquote></div><div class="SIntrapara">Decrypts data from <span class="RktVar">input-port</span>, using <span class="RktVar">password</span> as the password. Decrypted and decompressed data is written to <span class="RktSym">output-port</span>.</div></p><p>If <span class="RktVar">use-external-lz4?</span> is <span class="RktVal">#t</span>, the <a href="https://github.com/lz4/lz4"><span class="RktInBG"><span class="hspace"></span><span class="RktIn">lz4</span><span class="hspace"></span></span></a> is used. If it is missing in the system path, an error is raised.</p><p>The external lz4 program can be slightly faster for hundreds of MBs of data.</p><p><div class="SIntrapara"><blockquote class="SVInsetFlow"><table cellspacing="0" cellpadding="0" class="boxed RBoxed"><tr><td><blockquote class="SubFlow"><div class="RBackgroundLabel SIEHidden"><div class="RBackgroundLabelInner"><p>procedure</p></div></div><table cellspacing="0" cellpadding="0" class="prototype RForeground"><tr><td valign="top"><span class="RktPn">(</span><a name="(def._((lib._synology-decrypt/main..rkt)._decrypt-file))"></a><span title="Provided from: synology-decrypt | Package: synology-decrypt"><span class="RktSym"><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28def._%28%28lib._synology-decrypt%2Fmain..rkt%29._decrypt-file%29%29" class="RktValDef RktValLink" data-pltdoc="x">decrypt-file</a></span></span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktVar">password</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktVar">input</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktVar">output-port</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td></tr><tr><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktPn">#:external-lz4</span><span class="hspace">&nbsp;</span><span class="RktVar">use-external-lz4?</span><span class="RktPn">)</span></td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top">&rarr;</td><td valign="top"><span class="hspace">&nbsp;</span></td><td valign="top"><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/void.html#%28def._%28%28quote._~23~25kernel%29._void~3f%29%29" class="RktValLink" data-pltdoc="x">void?</a></span></td></tr></table></blockquote></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">password</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/strings.html#%28def._%28%28quote._~23~25kernel%29._string~3f%29%29" class="RktValLink" data-pltdoc="x">string?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">input</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/Manipulating_Paths.html#%28def._%28%28lib._racket%2Fprivate%2Fmisc..rkt%29._path-string~3f%29%29" class="RktValLink" data-pltdoc="x">path-string?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">output-port</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/port-ops.html#%28def._%28%28quote._~23~25kernel%29._output-port~3f%29%29" class="RktValLink" data-pltdoc="x">output-port?</a></span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktVar">use-external-lz4?</span><span class="hspace">&nbsp;</span>:<span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">or/c</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/booleans.html#%28def._%28%28quote._~23~25kernel%29._boolean~3f%29%29" class="RktValLink" data-pltdoc="x">boolean?</a></span><span class="hspace">&nbsp;</span><span class="RktVal">'</span><span class="RktVal">decide</span><span class="RktPn">)</span></td></tr></table></blockquote></div><div class="SIntrapara">Decrypts data from the file with path <span class="RktVar">input</span> which must be readable, using <span class="RktVar">password</span> as the password. Decrypted and decompressed data is written to the path <span class="RktSym">output</span>.</div></p><p>If <span class="RktVar">use-external-lz4?</span> is <span class="RktVal">'</span><span class="RktVal">decide</span>, some heuristics are used to decide whether to use internal or external lz4 based on the size of the file. If it is a <span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/booleans.html#%28def._%28%28quote._~23~25kernel%29._boolean~3f%29%29" class="RktValLink" data-pltdoc="x">boolean?</a></span> the semantics are that of <span class="RktSym"><a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28def._%28%28lib._synology-decrypt%2Fmain..rkt%29._decrypt-ports%29%29" class="RktValLink" data-pltdoc="x">decrypt-ports</a></span>.</p><h3>3<tt>&nbsp;</tt><a name="(part._file-format)"></a>Encrypted File Format</h3><p>The Synology Cloudsync encrypted file is a binary file describing structured data.
The structured data begins with some magic bytes identifying the file, then a series of <a name="(tech._dictionary)"></a><span style="font-style: italic">dictionaries</span>.
Dictionary keys are strings, while values can be integers, byte strings, strings or nested <a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28tech._dictionary%29" class="techoutside" data-pltdoc="x"><span class="techinside">dictionaries</span></a>.</p><h4>3.1<tt>&nbsp;</tt><a name="(part._.Syntax)"></a>Syntax</h4><p>The syntax can be described with this BNF grammar.</p><p><table cellspacing="0" cellpadding="0"><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">file</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">magic</span>&#8250;</span><span class="hspace">&nbsp;</span><span class="sroman">&#8249;<span style="font-style: italic">magic-hash</span>&#8250;</span><span class="hspace">&nbsp;</span><span class="sroman">&#8249;<span style="font-style: italic">dictionary</span>&#8250;</span><span style="vertical-align: super; font-size: 80%">+</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">magic</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">__CLOUDSYNC_ENC__</span><span class="hspace"></span></span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">magic-hash</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">d8d6ba7b9df02ef39a33ef912a91dc56</span><span class="hspace"></span></span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">dictionary</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">0x42</span><span class="hspace"></span></span><span class="hspace">&nbsp;</span><span class="sroman">&#8249;<span style="font-style: italic">dictionary-entry</span>&#8250;</span><span class="sroman">*</span><span class="hspace">&nbsp;</span><span class="RktInBG"><span class="hspace"></span><span class="RktIn">0x40</span><span class="hspace"></span></span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">dictionary-entry</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">key</span>&#8250;</span><span class="hspace">&nbsp;</span><span class="sroman">&#8249;<span style="font-style: italic">value</span>&#8250;</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">key</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">string</span>&#8250;</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">value</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">string</span>&#8250;</span><span class="stt"><span class="hspace">&nbsp;</span><span class="hspace">&nbsp;</span>|<span class="hspace">&nbsp;</span><span class="hspace">&nbsp;</span></span><span class="sroman">&#8249;<span style="font-style: italic">bytes</span>&#8250;</span><span class="stt"><span class="hspace">&nbsp;</span><span class="hspace">&nbsp;</span>|<span class="hspace">&nbsp;</span><span class="hspace">&nbsp;</span></span><span class="sroman">&#8249;<span style="font-style: italic">int</span>&#8250;</span><span class="stt"><span class="hspace">&nbsp;</span><span class="hspace">&nbsp;</span>|<span class="hspace">&nbsp;</span><span class="hspace">&nbsp;</span></span><span class="sroman">&#8249;<span style="font-style: italic">dictionary</span>&#8250;</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">string</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">0x10</span><span class="hspace"></span></span><span class="hspace">&nbsp;</span><span class="sroman">&#8249;<span style="font-style: italic">bytes-with-len</span>&#8250;</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">bytes</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">0x11</span><span class="hspace"></span></span><span class="hspace">&nbsp;</span><span class="sroman">&#8249;<span style="font-style: italic">bytes-with-len</span>&#8250;</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">int</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">0x01</span><span class="hspace"></span></span><span class="hspace">&nbsp;</span><span class="sroman">&#8249;<span style="font-style: italic">int-with-len</span>&#8250;</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">bytes-with-len</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">length</span>&#8250;</span><span class="hspace">&nbsp;</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._byte~3f%29%29" class="RktValLink" data-pltdoc="x">byte?</a></span><span style="vertical-align: super; font-size: 80%">+</span></p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">length</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p>unsigned short, big endian encoded (2 bytes)</p></td></tr><tr><td valign="baseline"><p><span class="hspace">&nbsp;</span></p></td><td valign="baseline"><p><span class="sroman">&#8249;<span style="font-style: italic">int-with-len</span>&#8250;</span></p></td><td valign="baseline"><p><span class="stt"><span class="hspace">&nbsp;</span>::=<span class="hspace">&nbsp;</span></span></p></td><td valign="baseline"><p>1 byte length followed by length bytes (in practice always 1)</p></td></tr></table></p><h4>3.2<tt>&nbsp;</tt><a name="(part._.Semantics)"></a>Semantics</h4><p>The encryption scheme uses the password to derive a 32-byte key and 16-byte initialization vector (IV). The <a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28part._kdf%29" data-pltdoc="x">Key Derivation Function</a> is the one used by OpenSSL. The key+IV is used to decrypt <span class="RktInBG"><span class="hspace"></span><span class="RktIn">enc_key1</span><span class="hspace"></span></span> using AES in Cipher Block Chaining (AES-CBC) mode.</p><p>The decrypted <span class="RktInBG"><span class="hspace"></span><span class="RktIn">enc_key1</span><span class="hspace"></span></span> will be a hex string. It should be converted to bytes and fed back into the <a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28part._kdf%29" data-pltdoc="x">Key Derivation Function</a>. This will result in the final key+IV used to decrypt the actual file contents.</p><p>The first dictionary in the file describes the <a name="(tech._encryption._information)"></a><span style="font-style: italic">encryption information</span>. It consists of the following key-value pairs:</p><ul><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"compress"</span><span class="hspace"></span></span> - always <span class="RktInBG"><span class="hspace"></span><span class="RktIn">1</span><span class="hspace"></span></span>, indicating the file has been compressed before encryption.</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"digest"</span><span class="hspace"></span></span> - TODO</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"enc_key1"</span><span class="hspace"></span></span> - base64 encoded, encrypted key. The user&rsquo;s password can be used to decrypt this to derive the decryption key.</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"enc_key2"</span><span class="hspace"></span></span> - TODO</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"encrypt"</span><span class="hspace"></span></span> - always <span class="RktInBG"><span class="hspace"></span><span class="RktIn">1</span><span class="hspace"></span></span>, indicating the file is encrypted.</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"file_name"</span><span class="hspace"></span></span> - string representing the original file name.</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"key1_hash"</span><span class="hspace"></span></span> - TODO</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"key2_hash"</span><span class="hspace"></span></span> - TODO</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"salt"</span><span class="hspace"></span></span> - a string containing the salt used for key derivation.</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"session_key_hash"</span><span class="hspace"></span></span> - TODO. Used to validate the encryption key integrity.</p></li><li><p><div class="SIntrapara"><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"version"</span><span class="hspace"></span></span> - a (sub) dictionary:
</div><div class="SIntrapara"><ul><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"major"</span><span class="hspace"></span></span> - <span class="RktInBG"><span class="hspace"></span><span class="RktIn">3</span><span class="hspace"></span></span></p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"minor"</span><span class="hspace"></span></span> - <span class="RktInBG"><span class="hspace"></span><span class="RktIn">1</span><span class="hspace"></span></span></p></li></ul></div></p></li></ul><p>Once the <a href="file:///home/nikhil/synology-decrypt/scribblings/synology-decrypt.html#%28tech._encryption._information%29" class="techoutside" data-pltdoc="x"><span class="techinside">encryption information</span></a> is obtained, the remaining file (except for the last dictionary) consists of <a name="(tech._data._dictionary)"></a><span style="font-style: italic">data dictionaries</span> which have two key-value pairs:</p><ul><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"type"</span><span class="hspace"></span></span> - always <span class="RktInBG"><span class="hspace"></span><span class="RktIn">"data"</span><span class="hspace"></span></span>.</p></li><li><p><span class="RktInBG"><span class="hspace"></span><span class="RktIn">"data"</span><span class="hspace"></span></span> - bytes representing encrypted chunks.</p></li></ul><p>The data values are always 8192 bytes long, except the last one. The way encryption is performed is to pass the original file through AES-CBC (which is a stream cipher) using the key+IV derived above. The data is padded with PKCS7 padding as part of the process. Then the encrypted data is split in 8192 byte chunks. If <span class="RktInBG"><span class="hspace"></span><span class="RktIn">"compress"</span><span class="hspace"></span></span> is true (<span class="RktInBG"><span class="hspace"></span><span class="RktIn">1</span><span class="hspace"></span></span>), the original file is compressed using LZ4 <span style="font-style: italic">before</span> encryption.</p><p>This means, to decrypt the data, one must feed all the chunks into a stateful AES decryption routine, initialized with the key+IV above. Then the data must be run through LZ4 decompression to obtain the original file.</p><p>Finally, the last dictionary in the file is an additional <span style="font-style: italic">meta-data dictionary</span> that contains the MD5 checksum of the decrypted (original) file.</p><h4>3.3<tt>&nbsp;</tt><a name="(part._kdf)"></a>Key Derivation Function</h4><p>TODO Describe in words.</p><blockquote class="SCodeFlow"><table cellspacing="0" cellpadding="0" class="RktBlk"><tr><td><span class="RktCmt">;</span><span class="RktCmt">&nbsp;</span><span class="RktCmt">helper</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">openssl-kdf-iter</span><span class="hspace">&nbsp;</span><span class="RktSym">password</span><span class="hspace">&nbsp;</span><span class="RktSym">salt</span><span class="hspace">&nbsp;</span><span class="RktSym">key-size</span><span class="hspace">&nbsp;</span><span class="RktSym">iv-size</span><span class="hspace">&nbsp;</span><span class="RktSym">key-iv-buffer</span><span class="hspace">&nbsp;</span><span class="RktSym">temp</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29" class="RktStxLink" data-pltdoc="x">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">repeat-count</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/if.html#%28form._%28%28quote._~23~25kernel%29._if%29%29" class="RktStxLink" data-pltdoc="x">if</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/Equality.html#%28def._%28%28quote._~23~25kernel%29._eq~3f%29%29" class="RktValLink" data-pltdoc="x">eq?</a></span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._bytes-length%29%29" class="RktValLink" data-pltdoc="x">bytes-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">salt</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktVal">1</span><span class="hspace">&nbsp;</span><span class="RktVal">1000</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/if.html#%28form._%28%28quote._~23~25kernel%29._if%29%29" class="RktStxLink" data-pltdoc="x">if</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._~3c%29%29" class="RktValLink" data-pltdoc="x">&lt;</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._bytes-length%29%29" class="RktValLink" data-pltdoc="x">bytes-length</a></span><span class="hspace">&nbsp;</span><span class="RktSym">key-iv-buffer</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/generic-numbers.html#%28def._%28%28quote._~23~25kernel%29._%2B%29%29" class="RktValLink" data-pltdoc="x">+</a></span><span class="hspace">&nbsp;</span><span class="RktSym">key-size</span><span class="hspace">&nbsp;</span><span class="RktSym">iv-size</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%29%29" class="RktStxLink" data-pltdoc="x">let</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">temp</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">repeated-hash</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._bytes-append%29%29" class="RktValLink" data-pltdoc="x">bytes-append</a></span><span class="hspace">&nbsp;</span><span class="RktSym">temp</span><span class="hspace">&nbsp;</span><span class="RktSym">password</span><span class="hspace">&nbsp;</span><span class="RktSym">salt</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">repeat-count</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym">openssl-kdf-iter</span><span class="hspace">&nbsp;</span><span class="RktSym">password</span><span class="hspace">&nbsp;</span><span class="RktSym">salt</span><span class="hspace">&nbsp;</span><span class="RktSym">key-size</span><span class="hspace">&nbsp;</span><span class="RktSym">iv-size</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._bytes-append%29%29" class="RktValLink" data-pltdoc="x">bytes-append</a></span><span class="hspace">&nbsp;</span><span class="RktSym">key-iv-buffer</span><span class="hspace">&nbsp;</span><span class="RktSym">temp</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktSym">temp</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktSym">key-iv-buffer</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;</span></td></tr><tr><td><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/define.html#%28form._%28%28lib._racket%2Fprivate%2Fbase..rkt%29._define%29%29" class="RktStxLink" data-pltdoc="x">define</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">openssl-kdf</span><span class="hspace">&nbsp;</span><span class="RktSym">password</span><span class="hspace">&nbsp;</span><span class="RktSym">salt</span><span class="hspace">&nbsp;</span><span class="RktSym">key-size</span><span class="hspace">&nbsp;</span><span class="RktSym">iv-size</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/let.html#%28form._%28%28lib._racket%2Fprivate%2Fletstx-scheme..rkt%29._let%2A%29%29" class="RktStxLink" data-pltdoc="x">let*</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktPn">[</span><span class="RktSym">count</span><span class="hspace">&nbsp;</span><span class="RktVal">1000</span><span class="RktPn">]</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">[</span><span class="RktSym">key-iv-output</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym">openssl-kdf-iter</span><span class="hspace">&nbsp;</span><span class="RktSym">password</span><span class="hspace">&nbsp;</span><span class="RktSym">salt</span><span class="hspace">&nbsp;</span><span class="RktSym">key-size</span><span class="hspace">&nbsp;</span><span class="RktSym">iv-size</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._bytes%29%29" class="RktValLink" data-pltdoc="x">bytes</a></span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._bytes%29%29" class="RktValLink" data-pltdoc="x">bytes</a></span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">]</span><span class="RktPn">)</span></td></tr><tr><td><span class="hspace">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/pairs.html#%28def._%28%28quote._~23~25kernel%29._list%29%29" class="RktValLink" data-pltdoc="x">list</a></span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._subbytes%29%29" class="RktValLink" data-pltdoc="x">subbytes</a></span><span class="hspace">&nbsp;</span><span class="RktSym">key-iv-output</span><span class="hspace">&nbsp;</span><span class="RktVal">0</span><span class="hspace">&nbsp;</span><span class="RktSym">key-size</span><span class="RktPn">)</span><span class="hspace">&nbsp;</span><span class="RktPn">(</span><span class="RktSym"><a href="file:///home/nikhil/racket/doc/reference/bytestrings.html#%28def._%28%28quote._~23~25kernel%29._subbytes%29%29" class="RktValLink" data-pltdoc="x">subbytes</a></span><span class="hspace">&nbsp;</span><span class="RktSym">key-iv-output</span><span class="hspace">&nbsp;</span><span class="RktSym">key-size</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span><span class="RktPn">)</span></td></tr></table></blockquote><h3>4<tt>&nbsp;</tt><a name="(part._.References_and_.Acknowledgements)"></a>References and Acknowledgements</h3><p>All the work to reverse engineer the file format was done by others.</p><ul><li><p>Marnix Klooster&rsquo;s Python <a href="https://github.com/marnix/synology-decrypt">synology-decrypt</a> implementation. This is the original reverse engineering of the encryption scheme and file format as far as I know. It was immensely useful!</p></li><li><p><a href="https://web.archive.org/web/20160606190954/https://global.download.synology.com/download/Document/WhitePaper/Synology_Cloud_Sync_White_Paper-Based_on_DSM_6.0.pdf">The Synology whitepaper</a>.</p></li></ul><p><div class="SIntrapara">This package relies on several Racket libraries.
</div><div class="SIntrapara"><ul><li><p>Bogdan Popa&rsquo;s <a href="https://pkgs.racket-lang.org/package/binfmt">binfmt</a> package was invaluable in quickly parsing the file format, and their <a href="https://pkgs.racket-lang.org/package/lz4">lz4</a> package was useful for decryption.</p></li><li><p>Ryan Culpepper&rsquo;s <a href="https://pkgs.racket-lang.org/package/crypto">crypto</a> package for an excellent cryptography implementation wrapping OpenSSL.</p></li></ul></div></p></div></div><div id="contextindicator">&nbsp;</div></body></html>